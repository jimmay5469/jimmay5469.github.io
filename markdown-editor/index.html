---
layout: default
title: Realtime Markdown Editor
css: ['markdown-editor.css', 'posts.css']
---
{% raw %}
<div id="emberContainer"></div>
<script type="text/x-handlebars" id="index">
  <div class="content">
    {{markdown-editor value=postMarkdown}}
  </div>
  <div class="titleInput">
    {{input value=title}}
  </div>
  <label class="dateLabel" for="postDate">Post Created:</label>
  <div class="dateInput">
    {{input id="postDate" value=postDate type="datetime"}}
  </div>
  <div class="toolbar">
    <button {{action clearPost}}>Reset Post</button>
    <br />
    <button {{action import}}>Import Post</button>
    <br /><br />
    <button {{action togglePreview}}>Preview Post</button>
  </div>
</script>
<script type="text/x-handlebars" id="preview">
  <div class="header-background-image"></div>
  <div class="header">
    <h1 class="title">{{title}}</h1>
  </div>

  <div class="content">
    <p class="meta">{{formattedPostDate}}</p>
    {{convert-markdown postMarkdown}}
    <div class="toolbar">
      <button {{action saveJekyll}}>Download Post</button>
      <br /><br />
      <button {{action togglePreview}}>Edit Post</button>
    </div>
  </div>
</script>
<script type="text/x-handlebars" id="import">
  <div class="importDataInput">
    {{textarea placeholder="Paste Jekyll post here." value=importData}}
  </div>
  <div class="toolbar">
    <button {{action import}}>Import</button>
    <button {{action cancel}}>Cancel</button>
  </div>
</script>
<script type="text/x-handlebars" id="components/markdown-editor">
  <div id="container" class="mdEditor">
    <div id="input">{{textarea value=value}}</div>
    <div id="output">{{convert-markdown value}}</div>
  </div>
</script>

<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/handlebars-v1.2.0.js"></script>
<script src="http://builds.emberjs.com/tags/v1.3.0-beta.3/ember.js"></script>
<script src="/js/marked.js"></script>
<script src="/js/moment.min.js"></script>

<script>
  marked.setOptions({
    gfm: true,
    breaks: true
  });

  var postValues = defaultPostValues = {
    title: 'Realtime Markdown Editor',
    postDate: new Date(),
    postMarkdown: '##Instructions:\n' + 
                  '1. Type markdown in the box on the left.\n' +
                  '2. Watch your markdown render realtime on the right.\n\n' +
                  'For more information visit [A realtime markdown editor, Part 1](/blog/2013/12/10/a-realtime-markdown-editor-part-1/)'
  };
  if(localStorage.getItem('markdownPost')) {
    postValues = JSON.parse(localStorage.getItem('markdownPost'));
  }

  App = Ember.Application.create({
    rootElement: '#emberContainer'
  });

  App.Router.map(function() {
    this.resource('preview');
    this.resource('import');
  });

  App.Post = Ember.Object.extend({
    title: postValues.title,
    postDate: new Date(postValues.postDate),
    formattedPostDate: function() {
      return moment(this.get('postDate')).format('D MMM YYYY');
    }.property('postDate'),
    postMarkdown: postValues.postMarkdown,
    json: function() {
      return { title: this.get('title'), postDate: this.get('postDate'), postMarkdown: this.get('postMarkdown') };
    }.property('title', 'postDate', 'postMarkdown'),
    triggerSave: function() {
      Ember.run.debounce(null, this.savePost, this.get('json'), 500);
    }.observes('title', 'postDate', 'postMarkdown'),
    savePost: function(json) {
      localStorage.setItem('markdownPost', JSON.stringify(json));
    }
  });

  Ember.Handlebars.helper('convert-markdown', function(markdown) {
    return new Ember.Handlebars.SafeString(marked(markdown));
  });

  var model = App.Post.create();
  App.IndexRoute = Ember.Route.extend({
    model: function() {
      return model;
    }
  });
  App.PreviewRoute = Ember.Route.extend({
    model: function() {
      return model;
    }
  });
  App.ImportRoute = Ember.Route.extend({
    model: function() {
      return model;
    }
  });

  App.IndexController = Ember.ObjectController.extend({
    actions: {
      togglePreview: function() {
        this.transitionToRoute('preview');
      },
      clearPost: function() {
        if(confirm('Are you sure? You will lose your current post!')) {
          this.set('title', defaultPostValues.title);
          this.set('postDate', new Date());
          this.set('postMarkdown', defaultPostValues.postMarkdown);
        }
      },
      import: function() {
        this.transitionToRoute('import');
      }
    }
  });
  App.PreviewController = Ember.ObjectController.extend({
    actions: {
      togglePreview: function() {
        this.transitionToRoute('index');
      },
      saveJekyll: function() {
        var postDate = moment(this.get('postDate'));
        var jekyllContent = '---\n' +
                            'layout: post\n' +
                            'title: "' + this.get('title') + '"\n' +
                            'date: ' + postDate.format('YYYY-MM-DD HH:mm:ss') + '\n' +
                            '---\n' +
                            '{% endraw %}{{ "{%" }} raw %}{% raw %}\n' +
                            this.get('postMarkdown') + '\n' +
                            '{% endraw %}{{ "{%" }} endraw %}{% raw %}';

        var encodedUri = encodeURI(jekyllContent); var link = document.createElement('a');
        link.setAttribute('href', 'data:text/plain;charset=utf-8,\uFEFF' + encodedUri);
        link.setAttribute('download', postDate.format('YYYY-MM-DD') + '-' + this.get('title').toLowerCase().replace(/[^\w\s]/g, '').replace(/ /g,"-") + '.md');
        link.click();
      }
    }
  });
  App.ImportController = Ember.ObjectController.extend({
    actions: {
      cancel: function() {
        this.set('importData', '');
        this.transitionToRoute('index');
      },
      import: function() {
        var importData = this.get('importData');
        try {
          var headerData = importData.split('---')[1].trim().split('\n');
          var bodyData = importData.substring(
            importData.indexOf('{% endraw %}{{ "{%" }} raw %}{% raw %}') + 9,
            importData.indexOf('{% endraw %}{{ "{%" }} endraw %}{% raw %}')
          ).trim();
          this.set('title', headerData[1].substring(headerData[1].indexOf('"') + 1, headerData[1].lastIndexOf('"')));
          this.set('postDate', new Date(headerData[2].substring(5).trim()));
          this.set('postMarkdown', bodyData);
        } catch(err) {
          this.set('title', 'Imported Post');
          this.set('postDate', new Date());
          this.set('postMarkdown', importData);
        }
        this.set('importData', '');
        this.transitionToRoute('index');
      }
    }
  });
</script>
{% endraw %}
