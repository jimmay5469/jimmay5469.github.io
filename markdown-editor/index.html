---
layout: default
title: Realtime Markdown Editor
css: ['markdown-editor.css', 'posts.css']
---
{% raw %}
<div id="emberContainer"></div>
<script type="text/x-handlebars">
  <div class="header-background-image"></div>
  <div class="header">
    <h1 class="title">{{title}}</h1>
  </div>

  <div class="content">
    {{#if preview}}
      {{convert-markdown postMarkdown}}
      <button class="togglePreviewButton" {{action togglePreview}}>Edit Post</button>
    {{else}}
      {{markdown-editor value=postMarkdown}}
      {{input class="titleInput" value=title}}
      <button class="togglePreviewButton" {{action togglePreview}}>Preview as Post</button>
    {{/if}}
    <button class="saveJekyllButton" {{action saveJekyll}}>Save as Jekyll Post</button>
  </div>
</script>
<script type="text/x-handlebars" id="components/markdown-editor">
  <div id="container" class="mdEditor">
    {{textarea id="input" value=value}}
    <div id="output">{{convert-markdown value}}</div>
  </div>
</script>

<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/handlebars-v1.2.0.js"></script>
<script src="http://builds.emberjs.com/tags/v1.3.0-beta.3/ember.js"></script>
<script src="/js/marked.js"></script>
<script src="/js/moment.min.js"></script>

<script>
  marked.setOptions({
    gfm: true,
    breaks: true
  });
  $.cookie.defaults.expires = 365;
  $.cookie.json = true;

  var postValues = defaultPostValues = {
    title: 'Realtime Markdown Editor',
    postMarkdown: '##Instructions:\n' + 
                  '1. Type markdown in the box on the left.\n' +
                  '2. Watch your markdown render realtime on the right.\n\n' +
                  'For more information visit [A realtime markdown editor, Part 1](/blog/2013/12/10/a-realtime-markdown-editor-part-1/)'
  };
  if($.cookie('markdownPost')) {
    postValues = $.cookie('markdownPost');
  }

  App = Ember.Application.create({
    rootElement: '#emberContainer'
  });

  App.Post = Ember.Object.extend({
    title: postValues.title,
    postMarkdown: postValues.postMarkdown,
    json: function() {
      return { title: this.get('title'), postMarkdown: this.get('postMarkdown') };
    }.property('title', 'postMarkdown'),
    triggerSave: function() {
      Ember.run.debounce(null, this.savePost, this.get('json'), 500);
    }.observes('title', 'postMarkdown'),
    savePost: function(json) {
      $.cookie('markdownPost', json);
    }
  });

  Ember.Handlebars.helper('convert-markdown', function(markdown) {
    return new Ember.Handlebars.SafeString(marked(markdown));
  });

  App.ApplicationRoute = Ember.Route.extend({
    model: function() {
      return App.Post.create();
    }
  });

  App.ApplicationController = Ember.ObjectController.extend({
    actions: {
      togglePreview: function() {
        this.toggleProperty('preview');
      },
      saveJekyll: function() {
        var postDate = moment();
        var jekyllContent = '---\n' +
                            'layout: post\n' +
                            'title: ' + this.get('title') + '\n' +
                            'date: ' + postDate.format('YYYY-MM-DD HH:mm:ss') + '\n' +
                            '---\n' +
                            '{% endraw %}{{ "{%" }} raw %}{% raw %}\n' +
                            this.get('postMarkdown') + '\n' +
                            '{% endraw %}{{ "{%" }} endraw %}{% raw %}';

        var encodedUri = encodeURI(jekyllContent); var link = document.createElement('a');
        link.setAttribute('href', 'data:text/plain;charset=utf-8,\uFEFF' + encodedUri);
        link.setAttribute('download', postDate.format('YYYY-MM-DD-') + this.get('title').toLowerCase().replace(/[^\w\s]/g, '').replace(/ /g,"-") + '.md');
        link.click();
      }
    }
  });
</script>
{% endraw %}
